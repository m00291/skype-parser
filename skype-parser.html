<!DOCTYPE html>
<html>
<head>
  <title>Archived conversations</title>
  <meta charset="utf-8">
  <meta content="default-src 'self';
    base-uri 'none';
    frame-ancestors: 'none';
    block-all-mixed-content">
  
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    p {
      margin: unset;
    }
    span img {
      display: unset;
    }
    #loading-all-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }
    #load-all-progress-container {
      background-color: lightgray;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      max-width: 80%;
    }
    #load-all-progress-text {
      margin: 0;
    }
    #progress-bar {
      width: 100%;
      background-color: #e0e0e0;
      height: 20px;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 10px;
    }
    #progress-bar-fill {
      width: 0%;
      background-color: lightskyblue;
      height: 100%;
      transition: width 0.3s;
    }
    #load-all-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 7;
    }
    #load-all-button {
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      overflow: hidden;
      padding: 10px 15px;
      background-color: lightsteelblue;
      color: darkslategray;
      font-weight: bold;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    #load-all-button::before {
      content: '';
      position: absolute;
      left: -90%;
      width: 120%;
      height: 100%;
      background: linear-gradient(135deg, #00000000, #00000000, #00000000, #00000000, #ffffffa1, #00000000, #00000000, #00000000, #00000000);
      transition: all 0.3s ease;
    }
    #load-all-button:hover::before {
      transform: translateX(130%);
    }
    #load-all-button::after {
      content: '';
      position: absolute;
      left: -90%;
      width: 120%;
      height: 100%;
      background: linear-gradient(135deg, #00000000, #00000000, #00000000, #00000000, #ffffffa1, #00000000, #00000000, #00000000, #00000000);
      transition: all 1s cubic-bezier(0.65, 0.05, 0.36, 1);
    }
    #load-all-button:hover::after {
      transform: translateX(130%);
    }
    a {
      word-break: break-all;
    }
    bing-response {
      display: block;
      overflow: auto;
    }
    .backform {
      height: 35px;
      width: 35px;
      border-radius: 50%;
      border: 1px solid;
      cursor: pointer;
      color: gray;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: transparent;
      padding: 0;
      margin-right: 0.5em;
    }
    .backform svg {
      width: 20px;
      height: 20px;
      stroke: gray;
      transition: stroke 0.2s ease;
    }
    .backform:hover {
      background-color: #b4cff5;
      border: 1px solid #b4cff5;
      color: white;
    }
    .backform:hover svg {
      stroke: white;
    }
    .phonecall {
      display: inline;
      padding-right: 25px;
    }
    .call_start {
      filter: invert(90%) sepia(100%) saturate(30%) brightness(69%) contrast(147%);
    }
    .call_end {
      padding-left: 8px;
      padding-right: 2px;
      rotate: 137deg;
      filter: invert(50%) sepia(68%) saturate(87%) brightness(38%) contrast(147%);
      position: absolute;
    }
    .call_miss_container {
      display: inline;
      padding-right: 4px;
    }
    .call_cross {
      z-index: 7;
      padding-left: 22px;
      padding-right: 2px;
      rotate: 200deg;
      font-size: 24px;
      font-family: cursive;
      position: absolute;
    }
    @font-face {
      font-family: "Segoe UI Local";
      font-weight: 200;
      src: local("Segoe UI Light");
    }
    @font-face {
      font-family: "Segoe UI Local";
      font-weight: 400;
      src: local("Segoe UI");
    }
    @font-face {
      font-family: "Segoe UI Local";
      font-weight: 600;
      src: local("Segoe UI Semibold");
    }
    body, html {
      height: 100%;
    }
    body {
      background-color: #f2f2f2;
      font: 1em "Segoe UI Local", "Segoe WP", "Segoe UI Web", Tahoma, "Helvetica Neue", Helvetica, "Meiryo UI", Meiryo, Arial Unicode MS, sans-serif;
      width: 100%;
      margin: 0 auto;
    }
    body.conversation {
      overflow-x: hidden;
    }
    .left {
      display: block;
      position: absolute;
      left: 0;
      top: 0;
      width: 30%;
      height: 100%;
      margin: 0;
      overflow: hidden;
    }
    .right {
      display: block;
      position: absolute;
      right: 0;
      top: 0;
      width: 70%;
      height: 100%;
      overflow: hidden;
    }
    div#selected-conversation-placeholder {
      display: block;
      width: 100%;
      top: 8rem;
      bottom: 0;
      position: absolute;
    }
    .object {
      width: 100%;
      height: 98%;
      overflow-x: hidden;
      overflow-x: hidden;
    }
    body.index {
      overflow: hidden;
    }
    div.header {
      position: fixed;
      top: 0;
      left: 1rem;
      width: 100%;
      background-color: #f2f2f2;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
    }
    h1 {
      color: #0b0b10;
      font-size: 1.5em;
      top: 0;
      left: 1rem;
      padding-top: 1rem;
      margin-top: 0;
      margin-bottom: 1rem;
      width: 100%;
      background-color: #f2f2f2;
    }
    h1.conversations {
      display: flex;
      position: static;
      margin-bottom: 0;
    }
    div.author {
      color: #626f82;
      padding-bottom: .5rem;
    }
    div.quote:before {
      display: block;
      height: 0;
      content: "“";
      margin-left: -1.5rem;
      font: italic 50px/1 Georgia, serif;
      color: #999;
    }
    div.quote {
      font-style: italic;
      margin-left: 1.5rem;
      margin-bottom: .5rem;
    }
    span.author {
      color: #626f82;
    }
    span.timestamp {
      color: #626f82;
      padding-left: .5rem;
      font-size: small;
    }
    span.deleted {
      color: #626f82;
      font-size: small;
    }
    span.timestamp-conv {
      color: #626f82;
      padding-left: .5rem;
      font-size: small;
    }
    span.messageCount {
      color: #626f82;
      font-size: small;
    }
    span.at:before {
      content: "@";
    }
    span.at {
      font-style: italic;
      color: #626f82;
    }
    ul {
      list-style-type: none;
      padding-left: 1rem;
      padding-right: 1rem;
      margin-top: 0rem;
      margin-bottom: 0rem;
      margin-block-end: unset;
    }
    ul.conversations {
      position: absolute;
      top: 8rem;
      bottom: 0;
      width: 90%;
      overflow-y: scroll;
    }
    li.message {
      color: #0b0b10;
      margin: .5rem auto;
      display: grid;
      justify-content: start;
    }
    .message-author {
      background-color: #fff;
      width: fit-content;
      border-radius: 15px;
      padding: 0.5rem 1rem 1rem;
      margin-bottom: -1rem;
    }
    .message-deleted {
      background-color: #e5e5e5;
      width: fit-content;
      border-radius: 15px;
      padding: 0.5rem 1rem;
    }
    .message-body {
      background-color: #fff;
      border-radius: 15px;
      border-top-left-radius: 0px;
      padding: 0.5rem 1rem;
      max-width: 800px;
      overflow-wrap: anywhere;
      position: relative;
    }
    .urlpreviews {
      margin-top: 10px;
      padding: 10px;
      border-radius: 8px;
      background-color: #f0f0f0;
      border: 1px solid #e0e0e0;
      width: fit-content;
      max-width: 500px;
      display: none;
    }
    .url-title {
      font-size: 1.1em;
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
    }
    .url-description {
      font-size: 0.9em;
      color: #666;
    }
    li.conversations {
      background-color: #f2f2f2;
      color: #0b0b10;
      padding-left: .25rem;
      padding-top: .5rem;
      padding-bottom: .5rem;
      margin: 0 auto;
      word-wrap: break-word;
      border-bottom-style: solid;
      border-bottom-width: thin;
      border-bottom-color: darkgray;
      cursor: pointer;
    }
    li.conversations-sel {
      background-color: #c7edfc82;
      color: #0b0b10;
      padding-left: .25rem;
      padding-top: .5rem;
      padding-bottom: .5rem;
      margin: 0 auto;
      word-wrap: break-word;
      border-bottom-style: solid;
      border-bottom-width: thin;
      border-bottom-color: #626f82;
    }
    li.conversations:hover {
      background: white;
    }
    li.conversations-sel:hover {
      background: #c7edfc;
    }
    .form {
      position: absolute;
      display: block;
      top: 100px;
      left: 50px;
      right: 50px;
      text-align: left;
    }
    .form fieldset {
      border-radius: 5px;
      border-color: #626f82;
      background-color: #c7edfc;
    }
    .primaryCta:hover,
    .promo a:hover .promo-link {
      color: #fff;
      background-color: #0b64a4;
    }
    .btn {
      box-sizing: border-box;
      border: 1px solid transparent;
      border-radius: 100px;
      cursor: pointer;
      display: inline-block;
      font-size: 16px;
      font-weight: 600;
      line-height: 24px;
      position: relative;
      text-align: center;
      text-decoration: none !important;
      word-wrap: break-word;
      padding: 12px 30px;
    }
    .primaryCta {
      color: #fff;
      background-color: #0078ca;
    }
    #progress {
      display: none;
    }
    pre {
      white-space: pre-wrap;
    }
    ul.details {
      list-style-type: circle;
      padding-left: 1rem;
      padding-right: 1rem;
      padding-top: 0;
      margin-top: 0;
      margin-bottom: 10px;
      padding-bottom: 10px;
    }
    #selected-conversation-header {
      margin-top: 50px;
    }
    .step-1,
    .step-2 {
      display: none;
    }
    .imggif {
      height: 80px;
      width: 80px;
    }
    .imgerr {
      max-width: 200px;
      max-height: 20px;
      white-space: nowrap;
    }
    .divimgerr {
      display: flex;
      flex-direction: column;
    }
    .divimgerr .play-button {
      display: none;
    }
    .step-1.form ol li {
      margin-top: 10px;
      margin-bottom: 10px;
    }
    input[type="text"] {
      width: 250px;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 5px;
      outline: none;
    }
  </style>
  <style>
    .file-upload {
      text-align: center;
    }

    .file-drop-area {
      border: 2px dashed #007BFF;
      border-radius: 8px;
      padding: 30px;
      cursor: pointer;
      transition: 0.3s;
    }

    .file-drop-area:hover {
      border: 2px dashed #007bff00;
      background-color: #007bff1f;
    }

    .file-drop-area.active {
      border: 2px dashed #007bff00;
      background-color: #007bff1f;
    }

    .form fieldset.active {
      border: 2px dashed #007BFF;
      transition: 0.3s;
    }

    .file-label {
      font-size: 16px;
      color: #333;
    }

    .file-input {
      display: none;
    }

    .file-name {
      margin-top: 20px;
      font-size: 16px;
      color: #555;
      word-wrap: break-word;
    }
    .media-container {
      max-width: 300px;
      max-height: 300px;
    }
    .jsonimg {
      max-width: inherit;
      max-height: inherit;
      cursor: pointer;
    }
    .ext {
      color: #626f82;
      font-size: small;
      display: block;
    }
    img, video {
      display: block;
      border: 2px solid #ddd;
      border-radius: 5px;
      background-color: white;
      box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
    }
    .emoji {
      border: 0;
      box-shadow: unset;
      display: inline;
      border-radius: 0;
      width: 2rem;
    }
    .emojichat {
      width: 4rem;
    }
    .emotions_marginbottom {
      margin-bottom: 2.5em;
    }
    .emotions_block {
      display: flex;
      position: absolute;
    }
    .emotions_json {
      display: none;
    }
    .emotions_box {
      margin: 0px 3px;
      padding: 3.5px;
      width: 40px;
      height: 40px;
      background-color: white;
      border-radius: 50%;
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      white-space: nowrap;
    }
    .emotions_box .emoji {
      height: 80%;
      width: 80%;
    }
    .emotions_tooltip {
      visibility: hidden;
      background-color: #333;
      color: #fff;
      text-align: left;
      border-radius: 2em;
      font-size: small;
      padding: 0.5rem 1rem;
      position: absolute;
      z-index: 10;
      top: 100%;
      left: 0;
      margin-top: 5px;
      opacity: 0;
      transition: opacity 0.2s;
      white-space: nowrap;
    }
    .emotions_box:hover .emotions_tooltip {
      visibility: visible;
      opacity: 1;
    }
    .suggestedActions {
      background-color: lightgray;
      padding: 0.25em 0.5em;
      margin-top: 0.5em;
      border-radius: 0.5em;
      width: fit-content;
    }
    .bing_box {
      background-color: white;
      padding: 0.5em;
      border-radius: 0.5em;
      margin: 0.25em;
    }
    .poll_box {
      background-color: white;
      padding: 0.5em;
      border-radius: 0.5em;
      margin: 0.25em;
      display: flex;
      position: relative;
    }
    .poll_tooltip {
      visibility: hidden;
      background-color: #333;
      color: #fff;
      text-align: left;
      border-radius: 2em;
      font-size: small;
      padding: 0.5rem 1rem;
      position: absolute;
      z-index: 10;
      bottom: 100%;
      left: 100%;
      transform: translate(0, 100%);
      opacity: 0;
      transition: opacity 0.2s;
      white-space: nowrap;
    }
    .poll_box:hover .poll_tooltip {
      visibility: visible;
      opacity: 1;
    }
    .attribution_text {
      margin-bottom: 0.5em;
    }
    .bing_ref {
      background-color: lightgray;
      margin-left: 1em;
      border-left: 0.3em solid gray;
      padding-left: 0.3em;
      font-size: smaller;
    }
    video {
      background: black;
    }
    .quote-container {
      background: #647fff5c;
      padding: 10px;
      box-shadow: 2px 2px 10px 4px rgba(0, 0, 0, 0.1);
      width: fit-content;
      border-radius: 10px;
      z-index: 2;
      position: relative;
      margin-bottom: 5px;
    }
    .attachment_container {
      background: #5b5b5b5c;
      padding: 1rem;
      width: fit-content;
      word-break: break-all;
      border-radius: 10px;
    }
    .redirect_icon {
      color: gray;
      margin-right: 5px;
      font-size: 20px;
      font-weight: bold;
      transform: scaleY(-1);
      display: inline-block;
    }
    legacyquote:hover a.msgredirect span {
      color: black;
    }
    legacyquote a {
      display: flex;
      text-decoration: none;
    }
    legacyquote {
      display: flex;
      align-items: center;
    }
  </style>
  <style>
    .video-thumbnail-container {
      position: relative;
      display: inline-block;
      background-color: rgb(0 0 0 / 80%);
      border-radius: 5px;
    }
    /* Play button overlay */
    .play-button {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 60px;
      height: 60px;
      background-color: rgb(0 0 0 / 40%);
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      pointer-events: none; /* Allows clicks to pass through to the image */
    }
    /* Play triangle inside the button */
    .play-button::after {
      content: '';
      display: block;
      width: 0;
      height: 0;
      border-top: 15px solid transparent;
      border-bottom: 15px solid transparent;
      border-left: 25px solid rgb(255 255 255 / 50%);
      margin-left: 5px; /* Adjust for centering */
    }
    .video-thumbnail {
      cursor: pointer;
      transition: 0.5s;
    }
    .video-thumbnail:hover {
      opacity: 70%;
    }
    #videoModal {
      display: flex;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.44);
      justify-content: center;
      align-items: center;
      z-index: 9;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s ease, visibility 0.2s ease;
    }
    #videoModal.show {
      opacity: 1;
      visibility: visible;
    }
    #videoModal video {
      max-width: 90%;
      max-height: 90%;
    }
    #imgModal {
      display: flex;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.44);
      justify-content: center;
      align-items: center;
      z-index: 9;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s ease, visibility 0.2s ease;
    }
    #imgModal.show {
      opacity: 1;
      visibility: visible;
    }
    #imgPlayer {
      cursor: grab;
      max-width: 90%;
      max-height: 90%;
      position: relative;
      overflow: hidden;
    }
    #imgPlayer.dragging {
      cursor: grabbing;
    }
    #messages {
      height: 100%; /* Adjust as needed */
      overflow: auto;
    }
  </style>
</head>
<body>
  <div class="left step-2">
    <div class="header">
      <h1 class="conversations">
        <button class="backform" onclick="window.location.reload()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round">
            <polyline points="15 18 9 12 15 6" />
          </svg>
        </button>
        <div>Archived conversations</div>
      </h1>
      <table class="step-2">
        <tbody>
          <tr>
            <th>User</th>
            <td id="hdr-user"></td>
          </tr>
          <tr>
            <th>Exported</th>
            <td id="hdr-exported"></td>
          </tr>
          <tr>
            <th>Total</th>
            <td id="hdr-stats"></td>
          </tr>
        </tbody>
      </table>
    </div>
    <ul class="conversations step-2" id="conversations"></ul>
  </div>
  <div id="selected-conversation step-2" class="right">
    <h1 class="conversation step-2" id="selected-conversation-header"></h1>
    <div id="selected-conversation-placeholder" class="step-2">
      <div id="videoModal">
        <video id="videoPlayer" controls>
          <source src="" type="video/mp4">
          Your browser does not support the video tag.
        </video>
      </div>
      <div id="imgModal">
        <img id="imgPlayer" src="" alt="">
      </div>
      <ul class="messages" id="messages"></ul>
    </div>
  </div>
  <div class="step-1 form">
    <form id="jsonFile" name="jsonFile" enctype="multipart/form-data" method="post">
      <fieldset>
        <h3>View your Skype conversation history export</h3>
        <ol>
          <li>Request an <a href="https://go.skype.com/export" target="_blank">export of your Skype conversations</a></li>
          <li>Once available, <a href="https://go.skype.com/export" target="_blank">download the exported file</a></li>
          <li>
            Unpack the TAR file
            <ul class="details">
              <li>On Windows, you can use the free <a href="https://www.7-zip.org/" target="_blank">7-zip</a> or similar tool</li>
              <li>On Mac, you can double-click the file to extract it</li>
            </ul>
          </li>
          <li><strong>Select the&nbsp;</strong><pre>messages.json</pre><strong>&nbsp;file from the export:&nbsp;</strong>
            <div class="file-upload">
              <div class="file-drop-area" id="drop-area">
                <p class="file-label">Drag & Drop JSON File Here</p>
                <input type="file" accept=".json" id="fileinput" class="file-input">
              <span class="file-name" id="file-name">No file selected</span>
              </div>
            </div>
          </li>
          <li>
            <strong>(Optional) Media file path from the export: </strong><input type="text" id="filePath" placeholder="C:\path\media">
            <div style="color: #555;">( eg: C:\Users\user\Desktop\export\media )</div>
          </li>
          <li><strong>Click the&nbsp;</strong><input type="button" id="btnLoad" value="Load" class="btn primaryCta"></li>
        </ol>
        <br>
        <div id="progress">Processing...</div>
      </fieldset>
    </form>
  </div>
  
  <script type="text/javascript">
    const maxRetries = 2; // minimum 1 for switching extensions
    
    const emojiMappingUrl = 'https://raw.githubusercontent.com/m00291/skype-parser/main/full-list-of-emoticons/emojiMapping.json';
    const emojiCache = {};
    let emojiMapping = null; // Variable to store the mapping
    let isLoading = false; // Flag to prevent multiple fetch calls

    // Load emoji mapping
    function loadEmojiMapping(callback) {
      if (emojiMapping) {
        // If already loaded, call the callback immediately
        callback(emojiMapping);
        return;
      }

      if (isLoading) {
        // If loading is in progress, just return
        return;
      }

      isLoading = true; // Set loading flag

      fetch(emojiMappingUrl)
        .then(response => response.json())
        .then(data => {
          emojiMapping = data; // Store the fetched mapping
          isLoading = false; // Reset loading flag
          callback(emojiMapping);
        })
        .catch(error => {
          //console.error('Error loading emoji mapping:', error);
          isLoading = false; // Reset loading flag on error
        });
    }
    function findEmoji(shortcutToTry) {
      for (const key in emojiMapping) {
        const emoji = emojiMapping[key];
        if (emoji.shortcuts.includes(`(${shortcutToTry})`) || emoji.shortcuts.includes(shortcutToTry)) {
          if (!emojiCache[key]) {
            const img = document.createElement('img');
            img.src = emoji.imageUrl;
            img.alt = shortcutToTry;
            img.title = shortcutToTry;
            img.className = 'emoji';
            img.setAttribute('loading', 'lazy');
            emojiCache[key] = img;
          }
          return emojiCache[key].cloneNode(); // Return a copy
        }
      }
      return null;
    }
    function normalizeShortcut(shortcut) {
      const mapping = {
        'clapskypesmilie': 'clap',
        '2714_heavycheckmark': 'checkmark',
        '1f624_facewithlookoftriumph': 'facewithsteamfromnose',
        '1f479_japaneseogre': 'ogre',
      };

      const normalized = shortcut.toLowerCase().trim();
      return mapping[normalized] || normalized;
    }
    const EMOJI_REGEX = /<ss([^>]*)>([^<]*)<\/ss>/gi;
    function replaceemoji(content) {
      return content.replace(EMOJI_REGEX, (match, attrs, inner) => {
        // Try to extract the type attribute from the attributes string
        const typeMatch = attrs.match(/type=["']?([^"'\s>]+)["']?/i);
        const type = typeMatch ? typeMatch[1].toLowerCase().trim() : null;

        // Normalize inner content
        const shortcut = normalizeShortcut(inner);

        let result = null;

        // 1. Try using inner content first
        if (shortcut) {
          result = findEmoji(shortcut);
        }

        // 2. If not found, try fallback transformation on shortcut
        if (!result && shortcut) {
          //console.log(shortcut);
          const transformedShortcut = '(' + shortcut.replace(/^.*?_/, '').replace(/:[^:]*$/, '').replace(/[()]/g, '') + ')';
          //console.log(transformedShortcut);
          result = findEmoji(transformedShortcut);
        }

        // 3. Still not found? Try using the type attribute
        if (!result && type) {
          //console.log(type);
          result = findEmoji(type);
        }

        // 4. Return emoji HTML if found, or fallback
        if (result) {
          return result.outerHTML;
        } else {
          return '[emoji]' + match; // fallback to original tag
        }
      });
    }
    function getemotionImgByShortcut(shortcut) {
      shortcut = normalizeShortcut(shortcut)

      // First attempt
      let result = findEmoji(shortcut);

      // If not found, try with your fallback transformation
      if (!result) {
        const transformedShortcut = shortcut.replace(/^.*?_/, '').replace(/:[^:]*$/, '');
        result = findEmoji(transformedShortcut);
      }

      if (!result) {
        return null;
      }

      return result;
    }
    
    let scale = 1;
    let isDragging = false;
    let position = { x: 0, y: 0 };
    let start = { x: 0, y: 0 };
    let imageStart = { x: 0, y: 0 };
    function updateTransform() {
      imgPlayer.style.transform = `translate(${position.x}px, ${position.y}px) scale(${scale})`;
    }
    const imgModal = document.getElementById('imgModal');
    const imgPlayer = document.getElementById('imgPlayer');
    function showimgModal() {
      if (imgModal.classList.contains('show')) {
        imgModal.classList.remove('show');
      } else {
        imgModal.classList.add('show');
        scale = 1;
        position = { x: 0, y: 0 };
        start = { x: 0, y: 0 };
        imageStart = { x: 0, y: 0 };
        imgPlayer.style.transform = `scale(${scale})`;
      }
    }
    imgPlayer.addEventListener('mousedown', (e) => {
      isDragging = true;
      imgPlayer.classList.add('dragging');
      start.x = e.clientX;
      start.y = e.clientY;
      imageStart.x = position.x;
      imageStart.y = position.y;
    });
    document.addEventListener('mousemove', (e) => {
      if (!isDragging) return;
      const dx = e.clientX - start.x;
      const dy = e.clientY - start.y;
      position.x = imageStart.x + dx;
      position.y = imageStart.y + dy;
      updateTransform();
    });
    document.addEventListener('mouseup', () => {
      isDragging = false;
      imgPlayer.classList.remove('dragging');
    });
    imgPlayer.ondragstart = () => false;
    imgModal.addEventListener('click', (event) => {
      if (event.target === imgModal) {
        showimgModal();
      }
    });
    imgModal.addEventListener('wheel', function(e) {
      e.preventDefault();

      if (Math.sign(e.deltaY) < 0) {
        scale += 0.1;
      } else {
        scale -= 0.1;
      }
      scale = Math.min(Math.max(0.1, scale), 5);
      updateTransform();
    });
    function showimg(imgElement) {
      imgPlayer.src = imgElement.src;
      imgPlayer.title = imgElement.src;
      showimgModal();
    }
    
    const videoModal = document.getElementById('videoModal');
    const videoPlayer = document.getElementById('videoPlayer');
    videoModal.addEventListener('click', (event) => {
      if (event.target === videoModal) {
        videoModal.classList.toggle('show');
        videoPlayer.pause();
      }
    });
    function playvideo(imgElement) {
      var videosrc = imgElement.src;
      videoPlayer.src = videosrc.substring(0 , videosrc.length - 14) + '1.mp4';
      videoModal.classList.toggle('show');
      videoPlayer.play();
    }
    
    // 圖片載入失敗時重試
    function retryLoadImage(imgElement, imageUrl, retries, e) {
      
      const parentele = imgElement.parentElement;
      const extele = parentele.parentElement;
      if (retries > 0) {
        //console.info(`載入中(${maxRetries - retries + 1}/${maxRetries}):`, e);
        setTimeout(() => {
          imgElement.src = imageUrl + "?retry=" + (maxRetries - retries + 1); // 加入參數避免瀏覽器快取
          imgElement.onerror = function () {
            retryLoadImage(imgElement, imageUrl, retries - 1, e);
          };
        }, 100); // 0.1 秒後重試
      } else {
        //console.error(`載入失敗(${maxRetries}/${maxRetries}):`, e);
        
        imgElement.title = e;
        imgElement.className = 'imgerr';
        
        imgElement.parentNode.className = "divimgerr";
        
        try {
          var ext = extele.getElementsByClassName("ext")[0];
          if (ext.textContent == '(mp4)') {
            ext.textContent = '(unknown)';
            imgElement.setAttribute('onclick','');
          }
          ext.textContent += '(error 404)';
        } catch(err) {}
      }
    }
    function retryLoadMedia(imgElement, imageUrl, retries, e, currentExtensionIndex = 0) {
      
      const extensions = ['jpeg', 'png', 'gif'];
      const parentele = imgElement.parentElement;
      const extele = parentele.parentElement;
      
      if (currentExtensionIndex < extensions.length) {
        const ex = extensions[currentExtensionIndex];
        
        if (retries > 0) {
          //console.info(`載入中(${maxRetries - retries + 1}/${maxRetries}):`, `${e}.1.${ex}`);
          setTimeout(() => {
            imgElement.src = imageUrl + ".1." + ex + "?retry=" + (maxRetries - retries + 1); // Adding parameter to avoid browser cache
            if (currentExtensionIndex == 2) {
              imgElement.className = "imggif";
            }
            imgElement.onerror = function () {
              retryLoadMedia(imgElement, imageUrl, retries - 1, e, currentExtensionIndex);
            };
            
            try {
              extele.getElementsByClassName("ext")[0].textContent = '(' + ex + ')';
            } catch (err) {}
          }, 100); // 0.1 seconds before retry
        } else {
          // If retries for the current extension are exhausted, move to the next extension
          //console.warn(`載入失敗: ${e}.1.${ex}, 嘗試下一個擴展名`);
          retryLoadMedia(imgElement, imageUrl, maxRetries, e, currentExtensionIndex + 1);
        }
      } else {
        //console.warn(`${e} 載入失敗:`, extensions.join(", "));
        
        var play_btn = document.createElement("div");
        play_btn.className = 'play-button';
        imgElement.insertAdjacentElement("afterend", play_btn);
        
        parentele.classList.add('video-thumbnail-container');
        try {
          extele.getElementsByClassName("ext")[0].textContent = '(mp4)';
        } catch (err) {}
        imgElement.setAttribute('onclick','playvideo(this)');
        retryLoadImage(imgElement, imageUrl + ".2.jpeg", maxRetries, e);
        imgElement.className = "jsonimg";
        imgElement.classList.add('video-thumbnail');
      }
    }
    
    function media(e) {
      var p = document.getElementById("filePath").value;
      if (p) {
        var long_e = p + (p.endsWith('\\') ? '' : '\\') + e;
        var m = document.createElement("div");
        m.className = "media-container";
        
        // For images
        const img = new Image();
        img.src = long_e + '.1.jpeg';
        img.className = "jsonimg";
        img.setAttribute('onclick','showimg(this)');
        img.setAttribute('onerror', `retryLoadMedia(this, '${long_e.replace(/\\/g, '\\\\')}', ${maxRetries}, '${e}')`);
        img.setAttribute('onload', 'this.title = this.src');
        //img.setAttribute('loading','lazy');
        m.appendChild(img);
        
        var span = document.createElement("span");
        span.className = 'ext';
        span.innerText = '(jpeg)';
        
        return m.outerHTML + span.outerHTML;
      }
      return '<span style="font-family: serif, none;">[Media file: ' + e + ']<br><span style="font-size:small;">(provide file path to show image)</span></span>';
    }

    function formatDate(timestamp) {
      const date = new Date(timestamp);
      const day = String(date.getDate());
      const month = String(date.getMonth() + 1); // Months are 0-based
      const year = date.getFullYear();

      let hours = date.getHours();
      const minutes = String(date.getMinutes()).padStart(2, '0');
      const seconds = String(date.getSeconds()).padStart(2, '0');
      const ampm = hours >= 12 ? 'PM' : 'AM';
      hours = hours % 12 || 12;

      return `${day}/${month}/${year} ${hours}:${minutes}:${seconds} ${ampm}`;
    }
    
    !function() {
      "use strict";
      function c(e) {
        return e.displayName ? e.displayName == "  " ? "　" : u(e.displayName) : p(e.id);
      }
      function m(e) {
        e.preventDefault();
        var con = e.target.parentNode;

        // If already selected, do nothing
        if (con.classList.contains("conversations-sel")) {
          return;
        }

        // Deselect all list items
        var r = con.parentNode.getElementsByTagName("li");
        for (var o = 0; o < r.length; o++) {
          r[o].classList.remove("conversations-sel");
        }

        // Select the clicked item
        con.classList.add("conversations-sel");

        var t = parseInt(e.target.getAttribute("data-conv"), 10);
        var display_total = parseInt((e.target.nextElementSibling.getElementsByClassName("messageCount")[0].textContent).match(/\d+/)[0], 10);
        var n = document.getElementById("messages");
        
        document.getElementById("selected-conversation-header").textContent = c(window.Skype.conversations[t]);
        
        // Get the message list
        var a = window.Skype.conversations[t] && window.Skype.conversations[t].MessageList 
              ? window.Skype.conversations[t].MessageList 
              : [];

        // Clear existing messages
        n.innerHTML = '';
        
        // Initialize variables for lazy loading
        const messagesPerPage = 50;
        let currentPage = 0;
        let isLoading = false;
        let loadingAll = false;
        let progressUpdateActive = false;
  
        // reset load all button
        if (document.getElementById('load-all-container')) {
          try {
            document.getElementById('load-all-container').parentNode.removeChild(document.getElementById('load-all-container'));
          } catch (e) {
            console.error("Error removing load-all-container:", e);
          }
        }
  
        // Create a loading indicator that will appear at the bottom
        const loadingIndicator = document.createElement('div');
        loadingIndicator.id = 'lazy-loading-indicator';
        loadingIndicator.innerHTML = '<h2>Loading ...</h2>';
        loadingIndicator.style.display = 'none';
        loadingIndicator.style.padding = '100px';
        loadingIndicator.style.textAlign = 'center';
        n.appendChild(loadingIndicator);

        // Create "Load All Messages" overlay button
        const loadAllButtonContainer = document.createElement('div');
        loadAllButtonContainer.id = 'load-all-container';
        
        const loadAllButton = document.createElement('button');
        loadAllButton.id = 'load-all-button';
        loadAllButton.textContent = 'Load All Messages';
        
        loadAllButton.addEventListener('click', loadallmessages);
        
        loadAllButtonContainer.appendChild(loadAllButton);
        document.body.appendChild(loadAllButtonContainer);

        function renderMessage(message) {
          if (("" !== message.content) && !(message.properties && "isserversidegenerated" in message.properties)) {
            var r = document.createElement("li");
            r.className = "message";
            r.setAttribute("id", message.id);
            var o = document.createElement("div");
            o.className = "message-author";
            r.appendChild(o);
            var i = document.createElement("span");
            i.className = "author";
            i.textContent = p(message.displayName !== null ? message.displayName : message.from);
            o.appendChild(i);
            var l = document.createElement("span");
            l.className = "timestamp";
            l.textContent = formatDate(message.originalarrivaltime);
            o.appendChild(l);
            if (message.properties && "edittime" in message.properties) {
              var et = document.createElement("span");
              et.className = "timestamp";
              const date = new Date(parseInt(message.properties.edittime));
              et.textContent = '(' + formatDate(date) + ' edited)';
              o.appendChild(et);
            }
            var d = document.createElement("div");
            d.className = "message-body";
            
            var urlpreviews_s = '';
            if (message.properties && "urlpreviews" in message.properties) {
              urlpreviews_s = '<div class="urlpreviews">' + message.properties.urlpreviews + '</div>';
            }
            
            var suggestedActions_s = '';
            if (message.properties && "suggestedActions" in message.properties) {
              suggestedActions_s = '<div class="suggestedActions">' + JSON.stringify(message.properties.suggestedActions.actions) + '</div>';
            }
            
            var emotions_s = '';
            if (message.messagetype !== "Poll" && message.properties && "emotions" in message.properties) {
              emotions_s = '<div class="emotions_block"></div><div class="emotions_json">' + JSON.stringify(message.properties.emotions) + '</div>';
              d.classList.add("emotions_marginbottom");
            }
            
            var poll_emotions_s = '';
            if (message.messagetype === "Poll" && message.properties && "emotions" in message.properties) {
              poll_emotions_s = '<div class="poll_emotions_block"></div><div class="emotions_json">' + JSON.stringify(message.properties.emotions) + '</div>';
            }
            
            var isForwarded_s = '';
            if (message.properties && "forwardMetadata" in message.properties) {
              isForwarded_s = "isForwarded:true";
            }
            
            var Media_GenericFile_s = '';
            if (message.messagetype === "RichText/Media_GenericFile") {
              Media_GenericFile_s = "<div class='attachment_container'></div>";
            }
            
            if (message.messagetype === "RichText/Media_Album") {
              return null;
            }
            
            if (message.messagetype === "PopCard") {
              return null;
            }
            
            if (message.content.includes('<bing-response') && !message.properties) {
              return null;
            }

            let content = '';
            content = message.displayName === "Bing" || message.displayName === "Copilot"
                    ? message.content
                    : message.content.replace(/\$/g, '\\$');
            
            d.innerHTML = message.amsreferences == null || message.messagetype === "RichText/Media_GenericFile"
                        ? u(isForwarded_s + Media_GenericFile_s + content + urlpreviews_s + suggestedActions_s + emotions_s + poll_emotions_s)
                        : media(message.amsreferences) + u(emotions_s);
            r.appendChild(d);
            
            return r;
          } else if ("" === message.content && message.properties && "deletetime" in message.properties) {
            var r = document.createElement("li");
            r.className = "message";
            r.setAttribute("id", message.id);
            var o = document.createElement("div");
            o.className = "message-deleted";
            r.appendChild(o);
            var i = document.createElement("span");
            i.className = "author";
            i.textContent = p(message.displayName !== null ? message.displayName : message.from);
            o.appendChild(i);
            var l = document.createElement("span");
            l.className = "timestamp";
            if (message.messagetype === "Poll") {
              l.textContent = formatDate(parseFloat(message.properties.deletetime)) +" created Poll.";
            } else {
              l.textContent = formatDate(parseFloat(message.properties.deletetime)) +" [deleted]";
            }
            o.appendChild(l);
            
            return r;
          }
        }

        // Function to load and render a page of messages
        function loadMessages() {
          if (isLoading || (!loadingAll && currentPage * messagesPerPage >= a.length)) {
            return;
          }
          
          isLoading = true;
          loadingIndicator.style.display = 'block';
          
          const startIndex = currentPage * messagesPerPage;
          const endIndex = loadingAll ? a.length : Math.min(startIndex + messagesPerPage, a.length);
          const fragment = document.createDocumentFragment();
          
          setTimeout(() => {
            try {
              // Determine how many messages to process in this batch
              const batchEndIndex = loadingAll ? Math.min(startIndex + messagesPerPage, endIndex) : endIndex;
              
              for (let i = startIndex; i < batchEndIndex; i++) {
                if (i < a.length) {
                  const messageElement = renderMessage(a[i]);
                  if (messageElement) {
                    fragment.appendChild(messageElement);
                  }
                }
              }
              
              // Insert the new messages before the loading indicator
              n.insertBefore(fragment, loadingIndicator);
              
              currentPage++;
              
              // Update progress if we're loading all messages
              if (loadingAll && progressUpdateActive) {
                //updateLoadAllProgress(Math.min(currentPage * messagesPerPage, a.length), a.length); // some messages are not processed
                updateLoadAllProgress(Math.min(Math.ceil(currentPage * messagesPerPage / a.length * display_total), display_total), display_total);
              }
              
              // If we're loading all messages and haven't finished yet, schedule the next batch
              if (loadingAll && batchEndIndex < endIndex) {
                isLoading = false;
                loadMessages(); // Continue loading next batch
              } else {
                isLoading = false;
                
                // Hide loading indicator and load all button if we've loaded all messages
                if (currentPage * messagesPerPage >= a.length) {
                  loadingIndicator.style.display = 'none';
                  loadAllButtonContainer.style.display = 'none';
                  
                  // Stop progress updates
                  progressUpdateActive = false;
                  
                  // Remove overlay if it exists
                  const overlay = document.getElementById('loading-all-overlay');
                  if (overlay && overlay.parentNode) {
                    setTimeout(() => {
                      try {
                        overlay.parentNode.removeChild(overlay);
                      } catch (e) {
                        // Overlay might already be removed
                      }
                    }, 1000);
                  }
                }
                
                // Process math equations if MathJax is available
                if (window.MathJax && MathJax.typesetPromise) {
                  MathJax.typesetPromise([n]);
                }
              }
            } catch (error) {
              console.error('Error loading messages:', error);
              isLoading = false;
              loadingIndicator.innerHTML = '<p>Error loading messages. <a href="#" onclick="retryLoading(); return false;">Retry</a></p>';
            }
          }, 50);
        }
        
        // Function to load all messages
        function loadallmessages() {
          if (isLoading) return;
          
          loadingAll = true;
          loadAllButton.disabled = true;
          
          // Remove any existing overlay
          const existingOverlay = document.getElementById('loading-all-overlay');
          if (existingOverlay) {
            existingOverlay.parentNode.removeChild(existingOverlay);
          }
          
          // Create overlay to show progress
          const overlay = document.createElement('div');
          overlay.id = 'loading-all-overlay';
          
          const progressContainer = document.createElement('div');
          progressContainer.id = 'load-all-progress-container';
          
          const progressText = document.createElement('h3');
          progressText.id = 'load-all-progress-text';
          progressText.textContent = 'Loading all messages...';
          
          const progressBar = document.createElement('div');
          progressBar.id = 'progress-bar';
          
          const progressBarFill = document.createElement('div');
          progressBarFill.id = 'progress-bar-fill';
          
          progressBar.appendChild(progressBarFill);
          progressContainer.appendChild(progressText);
          progressContainer.appendChild(progressBar);
          overlay.appendChild(progressContainer);
          document.body.appendChild(overlay);
          
          // Start progress updates
          progressUpdateActive = true;
          
          // Start loading all messages
          loadMessages();
        }
        
        // Update progress function
        function updateLoadAllProgress(loaded, total) {
          if (!progressUpdateActive) return;
          
          const percent = Math.round((loaded / total) * 100);
          const progressBarFill = document.getElementById('progress-bar-fill');
          const progressText = document.getElementById('load-all-progress-text');
          
          if (progressBarFill) {
            progressBarFill.style.width = percent + '%';
          }
          
          if (progressText) {
            progressText.textContent = `Loading all messages: ${loaded}/${total} (${percent}%)`;
          }
          
          if (loaded >= total) {
            progressUpdateActive = false;
            
            setTimeout(() => {
              const overlay = document.getElementById('loading-all-overlay');
              if (overlay && overlay.parentNode) {
                try {
                  overlay.parentNode.removeChild(overlay);
                } catch (e) {
                  console.error("Error removing overlay after completion:", e);
                }
              }
            }, 1000);
          }
        }
        
        // Retry function in case of loading error
        window.retryLoading = function() {
          loadingIndicator.innerHTML = '<p>Loading more messages...</p>';
          loadMessages();
        };
        
        // Intersection Observer to detect when user scrolls near the bottom
        const observer = new IntersectionObserver((entries) => {
          if (entries[0].isIntersecting && !isLoading && !loadingAll) {
            loadMessages();
          }
        }, { 
          root: document.getElementById("selected-conversation-placeholder"),
          rootMargin: "200px",
          threshold: 0.1
        });
        
        // Observe the loading indicator
        observer.observe(loadingIndicator);
        
        // Load the first page immediately
        loadMessages();
        
        // Add scroll event listener as fallback for browsers that don't support IntersectionObserver
        const scrollContainer = document.getElementById("selected-conversation-placeholder");
        if (!window.IntersectionObserver) {
          scrollContainer.addEventListener('scroll', () => {
            const scrollPosition = scrollContainer.scrollTop + scrollContainer.clientHeight;
            const scrollHeight = scrollContainer.scrollHeight;
            
            // Load more when user scrolls to 80% of the current height
            if (scrollPosition > scrollHeight * 0.8 && !isLoading && !loadingAll) {
              loadMessages();
            }
          });
        }
      }
      function a(e, t) {
        document.getElementById(e).textContent = t;
      }
      function p(e) {
        return e.replace(/^8:/, "").replace(/^\d{2}:.+(@thread\.skype)/, "@thread.skype");
      }
      
      //----------------------------------------------------------------------------------------
      function u(e) {
        var messageId;
        const messageIdMatch = e.match(/messageid="(\d+)"/);
        if (messageIdMatch) {
          messageId = messageIdMatch[1];
        }
        
        const isForwardedtrue = e.match(/isForwarded:true/);
        
        loadEmojiMapping(emojiMapping => {
          e = replaceemoji(e);
        });
        
        const parser = new DOMParser();
        const doc = parser.parseFromString(e, 'text/html');
        
        // large emoji chat
        try {
          const emoji_chat = doc.getElementsByClassName("emoji");
          if (emoji_chat.length == 1 && doc.body.innerHTML === emoji_chat[0].outerHTML) {
            emoji_chat[0].classList.add("emojichat");
          }
          e = doc.body.innerHTML;
        } catch(err) {}
        
        // show emotions
        try {
          const emotions_block = doc.getElementsByClassName("emotions_block")[0];
          const emotions_json = JSON.parse(doc.getElementsByClassName("emotions_json")[0].textContent);
          
          emotions_json.forEach(item => {
            if (item.key !== 'reactionsConsumptionHorizon') {
              const div = document.createElement('div');
              div.className = 'emotions_box';

              const emotionsImg = getemotionImgByShortcut(item.key);

              if (emotionsImg) {
                div.appendChild(emotionsImg);
              } else {
                div.textContent = '[emotions]' + item.key;
              }

              // Tooltip
              const tooltip = document.createElement('div');
              tooltip.className = 'emotions_tooltip';

              // Format user info
              const userInfo = item.users.map(user => {
                  const date = formatDate(user.time);
                  return `${user.mri.replace("8:","")} ${date}`;
              }).join('<br>');

              tooltip.innerHTML = userInfo;
              div.appendChild(tooltip);
              emotions_block.appendChild(div);
            }
          });
          
          e = doc.body.innerHTML;
        } catch(err) {}
        
        // poll
        try {
          const URIObjectnode = doc.getElementsByTagName("uriobject")[0];
          const URIObjecttype = URIObjectnode.getAttribute("type");
          const poll_json = JSON.parse(doc.getElementsByClassName("emotions_json")[0].textContent);

          if (URIObjecttype === 'Poll') {
            var poll_block = document.createElement('div');
            poll_block.className = 'suggestedActions';
            poll_block.textContent = URIObjectnode.innerText;

            const polloptions = URIObjectnode.getAttribute("optionsEncoded").split('|');
            polloptions.forEach(opt => {
              const div = document.createElement('div');
              div.className = 'poll_box';
              div.textContent = decodeURI(opt);

              for (var i in poll_json) {
                if (poll_json[i].key.includes(decodeURI(opt))) {
                  // Tooltip
                  const tooltip = document.createElement('div');
                  tooltip.className = 'poll_tooltip';

                  // Format user info
                  const userInfo = poll_json[i].users.map(user => {
                      const date = formatDate(user.time);
                      return `${user.mri.replace("8:","")} ${date}`;
                  }).join('<br>');

                  tooltip.innerHTML = userInfo;
                  div.appendChild(tooltip);
                }
              }

              poll_block.appendChild(div);
            });

            var pollsvg =
            `<svg width="28" height="28" viewBox="0 0 28 28">
              <path d=" M 14 14 L 22 14 A 8 8 0 1 1 14 6 Z" fill="white" stroke="black" stroke-width="1" />
              <g transform="translate(3, -3)">
                <path d="M 14 14 L 14 6 A 8 8 0 0 1 22 14 Z" fill="white" stroke="black" stroke-width="1" />
              </g>
            </svg>`;

            URIObjectnode.outerHTML = poll_block.outerHTML + pollsvg + 'Poll';

            e = doc.body.innerHTML;
          }

        } catch (err) {}
        
        // show bing actions
        try {
          const bing_block = doc.getElementsByClassName("suggestedActions")[0];
          const bing_json = JSON.parse(bing_block.textContent);
          bing_block.textContent = 'Suggested Actions:';
          
          bing_json.forEach(item => {
            const div = document.createElement('div');
            div.className = 'bing_box';
            div.textContent = item.title;

            bing_block.appendChild(div);
          });
          
          e = doc.body.innerHTML;
        } catch(err) {}
        
        // show bing-response
        try {
          const bing = doc.getElementsByTagName("bing-response")[0];
          const bing_group = Array.from(bing.getElementsByTagName("attributions-group"));
          
          bing_group.forEach(group => {
            var att_group = Array.from(group.getElementsByTagName("attribution"));

            att_group.forEach(att => {
              var title = att.getAttribute("title");
              var src = att.getAttribute("href");
              
              att.remove();

              var span = document.createElement("span");
              span.className = 'bing_ref';
              span.textContent = title;

              if (src) {
                var a = document.createElement("a");
                a.href = src;
                a.textContent = src;
                span.append(' (');
                span.append(a);
                span.append(')');
              }

              group.append(span);
            });
          });
          
          e = doc.body.innerHTML;
        } catch (err) {}

        // show pictureupdate
        try {
          const pictureupdate = doc.getElementsByTagName("pictureupdate")[0];
          const value = pictureupdate.getElementsByTagName("value")[0];
          
          if (value.textContent.length > 0) {
            var newimg = document.createElement('img');
            newimg.src = value.textContent.substring(4);
            newimg.title = value.textContent.substring(4);
            pictureupdate.removeChild(value);
            pictureupdate.appendChild(document.createElement('br'));
            pictureupdate.appendChild(newimg);
            
            e = doc.body.innerHTML;
          }
        } catch(err) {}
        
        // show quote > media
        try {
          const quote = doc.getElementsByTagName("quote")[0];
          const URIObjectnode = quote.getElementsByTagName("URIObject")[0];
          const v_doc_id = URIObjectnode.getAttribute("doc_id");
          
          if (URIObjectnode.getElementsByTagName("swift").length == 0) {
            quote.removeChild(URIObjectnode);
            
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = media(v_doc_id);
            quote.appendChild(tempDiv);
          }
          
          e = doc.body.innerHTML;
        } catch(err) {}
        
        // show attachment
        try {
          const attachment_container = doc.getElementsByClassName("attachment_container")[0];
          const a = doc.getElementsByTagName("URIObject")[0];
          const filename = a.getElementsByTagName("OriginalName")[0].getAttribute("v");
          const filesize = a.getElementsByTagName("FileSize")[0].getAttribute("v");
          
          if (filename.length > 0) {
            var div = document.createElement('div');
            div.textContent = 'File: ' + filename;
            
            attachment_container.appendChild(div);
            
            if (filesize) {
              const bytes = parseInt(filesize, 10);
              const megabytes = (bytes / (1024 * 1024)).toFixed(2);
              
              var size = document.createElement('div');
              size.textContent = 'Size: ' + megabytes + 'MB';
              attachment_container.appendChild(size);
            }
            
            a.remove();
            e = doc.body.innerHTML;
          }
        } catch(err) {}
        
        // show url preview
        try {
          const preview = doc.getElementsByClassName("urlpreviews")[0];
          const previewjson = preview.textContent;
          
          if ("title" in JSON.parse(previewjson)[0].value) {
            preview.style.display = 'block';
            preview.textContent = '';
            
            var ti = document.createElement('div');
            ti.className = 'url-title';
            ti.textContent = JSON.parse(previewjson)[0].value.title;
            
            preview.append(ti);
          }
          
          if ("description" in JSON.parse(previewjson)[0].value) {
            var des = document.createElement('div');
            des.className = 'url-description';
            des.textContent = JSON.parse(previewjson)[0].value.description;
            
            preview.append(des);
          }
          
          e = doc.body.innerHTML;
        } catch(err) {}
        
        // remove botssettings
        try {
          const botssettingsnode = doc.getElementsByTagName("botssettings")[0];
          botssettingsnode.remove();

          e = doc.body.innerHTML;
        } catch(err) {}
        
        // At
        try {
          e = e.replace(/<at [^>]*>(.*?)<\/at>/g, (_, name) => `<b>@${name}</b>`);
        } catch(err) {}

        // sticker cannot be loaded
        try {
          const URIObjectnode = doc.getElementsByTagName("URIObject")[0];
          const URIObjecturi = URIObjectnode.getAttribute("uri");
          
          if ((URIObjectnode.textContent.includes("已傳送貼圖給您")) || (URIObjectnode.textContent.includes("A sticker was sent"))) {

            var img = document.createElement("img");
            img.className = "imgerr";
            img.src = URIObjecturi;
            img.title = URIObjecturi;
            
            var m = document.createElement("span");
            m.className = 'ext';
            m.textContent = '(sticker)';
            m.textContent += '(error 404)';
            
            var d = document.createElement("div");
            d.className = "divimgerr";
            d.appendChild(img);
            d.appendChild(m);
            
            e = d.outerHTML;
          }
        } catch(err) {}
        
        // tag content replacement logic
        const replacements = {
          duration: function(content) {
            const totalSeconds = parseFloat(content);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = (totalSeconds % 60).toFixed(0);
            return " (" + hours + "小時" + minutes + "分鐘" + seconds + "秒)";
          },
          legacyquote: function(content) {
            const match = content.match(/\[(\d+)\]/);
            
            if (match) {
              const date = new Date(parseInt(match[1], 10) * 1000);
              const formattedDate = formatDate(date);
              var icon = '<span class="redirect_icon">↩</span>';
              if (isForwardedtrue) {
                return '<a class>' + icon + '<span class="author">(Forwarded)' + content.replace(match[0], '') + '</span><span class="timestamp">' + formattedDate + '</span></a><br>';
              } else {
                return '<a class="msgredirect" href="#' + messageId + '">' + icon + '<span class="author">' + content.replace(match[0], '') + '</span><span class="timestamp">' + formattedDate + '</span></a><br>';
              }
            }
            
            return content;
          },
          eventtime: function(content) {
            return " ";
          },
          detailedtargetinfo: function(content) {
            return "";
          },
          rosterversion: function(content) {
            return "";
          },
          contacts: function(content) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(content, "text/xml");
            const fValue = xmlDoc.getElementsByTagName("c")[0].getAttribute("f");
            return "卡片[" + fValue + "]" + content;
          },
          // 處理 Base64 解碼
          base64decode: function(content) {
            try {
              return atob(content);
            } catch (e) {
              //console.error("Base64 解碼失敗:", e);
              return content; // 如果解碼失敗，返回原始內容
            }
          }
        };

        // 專門處理 Base64 解碼
        var base64Regex = /b64="([^"]+)"/;
        var match = base64Regex.exec(e);
        
        if (match && match[1]) {
          var base64String = match[1];
          var decodedContent = replacements.base64decode(base64String);
          var imageUrl = JSON.parse(decodedContent).attachments[0].content.images[0].url;
          
          var div = document.createElement("div");
          
          try {
            var img = document.createElement("img");
            img.className = "imggif";
            img.src = imageUrl;
            img.setAttribute('onerror', `retryLoadImage(this, '${imageUrl}', ${maxRetries}, '${imageUrl}')`);
            img.setAttribute('onload', 'this.title = this.src');
            
            div.className = "divgif";
            div.appendChild(img);
            
            var span = document.createElement("span");
            span.className = 'ext';
            span.innerText = '(gif)';
            div.appendChild(span);
            
          } catch (error) {
            //console.error("解析 JSON 失敗:", error);
            e = '<div>(decode base64 error)</div>';
          }
          
          try {
            const quote = doc.getElementsByTagName("quote")[0];
            const URIObjectnode = quote.getElementsByTagName("URIObject")[0];
            
            if (URIObjectnode.getElementsByTagName("swift").length > 0) {
              quote.removeChild(URIObjectnode);
              quote.appendChild(div);
              
              e = doc.body.innerHTML;
            }
          } catch (error) {
            e = div.outerHTML;
          }
        }

        // tag content to replace
        for (var tag in replacements) {
          var regex = new RegExp("<" + tag + "(\\s+[^>]*?)?>(.*?)</" + tag + ">", 'g');
          e = e.replace(regex, function(match, attrs, p1) {
            return "<" + tag + (attrs ? attrs : "") + ">" + replacements[tag](p1) + "</" + tag + ">";
          });
        }
        
        // text replacement logic
        const textreplacements = {
          "<pictureupdate": function() {
            return "變更圖片 <pictureupdate";
          },
          "<deletemember": function() {
            return "交談移除 <deletemember";
          },
          "<topicupdate": function() {
            return "交談重新命名 <topicupdate";
          },
          "<addmember": function() {
            return "交談加入 <addmember";
          },
          '<partlist type=\\\"started': function() {
            return '<span class="call_start" name="📞">📞</span>通話開始<partlist type=\\\"started';
          },
          '<partlist type=\\\"ended': function() {
            return '<div class="phonecall"><span class="call_end" name="📞">📞</span></div>通話結束<partlist type=\\\"ended';
          },
          '<partlist type=\\\"missed': function() {
            return '<div class="call_miss_container"><span class="call_cross">/</span><span class="call_miss" name="📞">📞</span></div>無人接聽<partlist type=\\\"missed';
          },
          '<part identity=': function() {
            return '<br>參與者: <part identity=';
          },
          '<target>': function() {
            return '<br><target>';
          },
          '<br><target>8:': function() {
            return '<br><target>';
          },
          '<initiator>8:': function() {
            return '<initiator>';
          },
          '<initiator>': function() {
            return '<initiator>(';
          },
          '</initiator>': function() {
            return ')</initiator>';
          },
          '<value>': function() {
            return '<br><value>';
          },
          '<eventtime>': function() {
            return '';
          },
          '<uriobject': function() {
            return 'uriobject<uriobject';
          },
          '<URIObject': function() {
            return 'uriobject<URIObject';
          },
          '<joiningenabledupdate>': function() {
            return 'joiningenabledupdate<joiningenabledupdate>';
          },
          '<historydisclosedupdate>': function() {
            return 'historydisclosedupdate<historydisclosedupdate>';
          },
          '<MediaAlbum': function() {
            return 'MediaAlbum<MediaAlbum';
          },
          '<quote ': function() {
            return '<div class=\"quote-container\"><quote ';
          },
          '</quote>': function() {
            return '</quote></div>';
          },
          '<legacyquote>\n\n&lt;&lt;&lt; </legacyquote>': function() {
            return '';
          },
          '<legacyquote>\r\n\r\n&lt;&lt;&lt; </legacyquote>': function() {
            return '';
          },
          '<a href=': function() {
            return '<a target=\"_blank\" href=';
          },
          '<attributions-group>': function() {
            return '<attributions-group  class="attribution_text">';
          },
          '</attributions-group>。': function() {
            return '</attributions-group>。<br>';
          },
          '<attributions-text': function() {
            return '<span';
          },
          '</attributions-text>': function() {
            return '</span>';
          },
          'isForwarded:true': function() {
            return '';
          }
        };

        // text to replace
        for (var key in textreplacements) {
          var textRegex = new RegExp(key, 'g');
          e = e.replace(textRegex, textreplacements[key]);
        }
        
        return e;
      }
      
      function u2(e) {
        return e;
      }
      
      function u_original(e) {
        return e.replace(/&apos;/g, "'").replace(/&amp;/g, "&").replace(/&lt;/g, "<").replace(/&gt;/g, ">");
      }
      function s(e, t) {
        for (var n = document.getElementsByClassName(e), a = 0; a < n.length; a++) n[a].style.display = t ? "block" : "none";
      }
      document.getElementById("btnLoad").addEventListener("click", function() {
        var e, t, n;
        "function" == typeof window.FileReader ? (e = document.getElementById("fileinput")) && e.files ? e.files[0] ? (document.getElementById("progress").style.display = "block", t = e.files[0], (n = new FileReader).onload = function(e) {
          var t = e.target.result;
          !function(e) {
            if (e && e.userId && e.conversations && e.exportDate) {
              var t = new Date(e.exportDate);
              var n = e.conversations.sort((a, b) => new Date(b.properties.lastimreceivedtime ? b.properties.lastimreceivedtime : b.version)
                                                   - new Date(a.properties.lastimreceivedtime ? a.properties.lastimreceivedtime : a.version));
              n = e.conversations.filter(function(e) {
                return e.id
                    && "ALL" !== e.id
                    && !/@cast\.skype$/.test(e.id)
                    && e.MessageList
                    && e.MessageList.length
                    && e.displayName !== "File Transfer"
                    && !e.id.includes('calllogs')
                    && (e.displayName || e.properties.conversationstatus);
              });
              n.forEach(function(convo) {
                convo.MessageList.sort((a, b) => new Date(b.originalarrivaltime) - new Date(a.originalarrivaltime));
              });
              a("hdr-user", p(e.userId)), a("hdr-exported", formatDate(t)), a("hdr-stats", n.length + " conversations"), function(e) {
                for (var t = document.getElementById("conversations"), n = 0; n < e.length; n++) {
                  var a = document.createElement("li");
                  a.className = "conversations";
                  var s = document.createElement("a");
                  s.setAttribute("href", "#"),
                  s.setAttribute("data-conv", n),
                  s.className = "conv-link",
                  s.textContent = c(e[n]),
                  a.appendChild(s);
                  var r = document.createElement("div");
                  a.appendChild(r);
                  var o = document.createElement("span");
                  o.className = "messageCount";
                  o.textContent = e[n].MessageList.length
                                - e[n].MessageList.reduce((count, message) => {
                                    return count
                                         + (message.properties && message.properties.isserversidegenerated ? 1 : 0)
                                         + (message.messagetype && message.messagetype === 'PopCard' ? 1 : 0)
                                         + (message.messagetype && message.messagetype === 'RichText/Media_Album' ? 1 : 0);
                                  }, 0)
                                + " messages";
                  r.appendChild(o);
                  var i = e[n].properties && e[n].properties.lastimreceivedtime ? e[n].properties.lastimreceivedtime : e[n].version;
                  if (i) {
                    var l = document.createElement("span");
                    l.className = "timestamp-conv", l.textContent = "Last from: " + formatDate(i), r.appendChild(l);
                  }
                  t.appendChild(a);
                }
                for (var d = document.getElementsByClassName("conv-link"), n = 0; n < d.length; n++) d[n].addEventListener("click", m);
                for (var li = document.querySelectorAll('li.conversations'), n = 0; n < li.length; n++) li[n].addEventListener('click', function() {
                  this.getElementsByClassName("conv-link")[0].click();
                });
              }(n), window.Skype = {}, window.Skype.conversations = n, s("step-1", !1), s("step-2", !0);
            } else {
              alert("Sorry, we are unable to load this file");
              document.getElementById("progress").style.display = "none";
            }
          }(JSON.parse(t));
        }, n.readAsText(t, "utf8")) : (alert("Please select a file before clicking 'Load'"), document.getElementById("progress").style.display = "none") : alert("This browser doesn't seem to support the 'files' property of file inputs.") : alert("The file API isn't supported on this browser. Please use a more modern browser.");
      }), s("step-2", !1), s("step-1", !0);
    }();
  </script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const inputBox = document.getElementById("filePath");

      // Load saved value from localStorage
      const savedpath = localStorage.getItem("temppath");
      if (savedpath) {
        inputBox.value = savedpath;
      }

      // Save input value on button click
      inputBox.addEventListener("input", function (e) {
        localStorage.setItem("temppath", inputBox.value);
      });
    });
  </script>
  <script>
    const fileInput = document.getElementById("fileinput");
    const dropArea = document.getElementById("drop-area");
    const fulldropArea = document.getElementById("jsonFile").getElementsByTagName("fieldset")[0];
    const fileNameText = document.getElementById("file-name");

    // Show selected file name
    function updateFileName(file) {
      if (file) {
        fileNameText.textContent = file.name;
      } else {
        fileNameText.textContent = "No file selected";
      }
    }

    // Handle file selection
    fileInput.addEventListener("change", function () {
      updateFileName(this.files[0]);
    });

    // Simulate click when button is pressed
    dropArea.addEventListener("click", function () {
      fileInput.click();
    });

    // Drag & Drop functionality
    
    fulldropArea.addEventListener("dragover", (event) => {
      event.preventDefault();
      if (!dropArea.classList.contains("active")) {
        dropArea.classList.add("active");
        fulldropArea.classList.add("active");
      }
    });
    
    fulldropArea.addEventListener("dragleave", () => {
      if (!fulldropArea.contains(event.relatedTarget)) {
        dropArea.classList.remove("active");
        fulldropArea.classList.remove("active");
      }
    });

    function handleDrop(event) {
      event.preventDefault();
      dropArea.classList.remove("active");
      fulldropArea.classList.remove("active");

      if (event.dataTransfer.files.length > 0) {
        let file = event.dataTransfer.files[0];
        if (file.type === "application/json") {
          fileInput.files = event.dataTransfer.files;
          updateFileName(file);
        } else {
          alert("Please select a valid JSON file.");
          fileInput.value = null;
          updateFileName();
        }
      }
    }
    fulldropArea.addEventListener("drop", handleDrop);
  </script>
</body>
</html>